<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>JSN-SR04_Gen3_RK: JSN-SR04_Gen3_RK</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">JSN-SR04_Gen3_RK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">JSN-SR04_Gen3_RK </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p ><a class="anchor" id="md_README"></a> <em>Library for JSN-SR04 ultrasonic distance sensor for Particle Gen 3 devices (Argon, Boron, B Series SoM, Tracker)</em></p>
<p >The JSN-SR04 is an inexpensive ultrasonic distance sensor. There are many manufacturers, some are weather resistant, and they have somewhat different supported ranges, but usually in the range of a few centimeters to maybe a few meters. Also note: these sensors are generally not all that reliable. I would not use one in a life-safety situation and be sure to code defensively for the case when it fails.</p>
<p >Once characteristic of the sensor is that you need to measure the pulse width to within a microsecond or so, and measurement takes around 150 microseconds of setup time and up to 29 milliseconds of pulse width (at 5 meters). At a more reasonable 1 meter, it's still around 9 milliseconds.</p>
<p >The problem on Gen 3 devices (nRF52840) is that even if you use interrupts, the interrupt latency is high, and extremely variable. The radio stack runs at a high interrupt priority and will delay other interrupts until completion. Because of the long time to sample, you don't want to disable interrupts because it will adversely affect the BLE radio, and the reset of the system. But if you do not disable interrupts, the interrupt latency makes for very inaccurate readings.</p>
<p >The solution is the technique used in this library: The nRF52840 I2S, note this is I2S, as in sound, not I2C, peripheral is really just a high-speed digital input and output device with hardware DMA. The library is configured to use 32,000 samples per second, with 16 bits per sample, stereo. This works out to a bit clock of 1 MHz, or 1 µs per sample bit, which is perfect for the JSN-SR04.</p>
<p >The library uses the I2S peripheral to both generate the TRIG pulse and measure the resulting ECHO pulse. It does so without ever disabling interrupts, and the interrupt occurs after the entire maximum measurement is complete. A deferred interrupt does not affect the accuracy of the sensor!</p>
<h2>Level shifter required!</h2>
<p >One caveat is the the JSN-SR04 sensors generally require 5V to operate properly.</p>
<p >Particle Gen 3 devices are not 5V tolerant because the nRF52840 MCU is not! Be sure to use a level shifter on the ECHO output from the JSN-SR04 to the GPIO on the Particle device, or you will likely permanently damage the pin on the Particle device.</p>
<p >Also note that since you need 5V you will not be able to power the sensor off the LiPo battery unless you use an external boost converter. If you are powered by USB, you can power the sensor from the VUSB bin.</p>
<p >Most JSN-SR04 sensors will trigger if TRIG only goes up to 3.3V so you generally don't need a level shifter on TRIG.</p>
<p >If you're looking for an inexpensive breadboard-friendly DIP package, the <a href="https://www.adafruit.com/product/1787">74AHCT125</a> can be used. It's overkill in that it's a quad level-shifter, but it works. Connect VCC on the chip to 3V3 because you're using it to reduce the voltage!</p>
<p >For custom boards I often use a <a href="https://www.digikey.com/product-detail/en/texas-instruments/SN74LVC1T45QDCKRQ1/296-39212-1-ND/5143211">Texas Instruments SN74LVC1T45</a> which comes in a tiny SC70-7 SMD package and is even less expensive.</p>
<h2>Lots of GPIO required</h2>
<p >Another caveat is that this library requires a lot of GPIO: four GPIO.</p>
<p >Of course there are the two standard JSN-SR04 pins, TRIG (output) and ECHO (input).</p>
<p >The unfortunate thing is that you also need to dedicate two other pins, unusedPin1 and unusedPin2. These must not be the same pin, and can't be used for anything else for all practical purposes. This is due to how the I2S peripheral works. You have to assign the I2S LRCK and SCK to pins or the nRF52 I2S peripheral won't initialize. You won't need these outputs for anything, but they do need to be assigned real GPIOs. The signals happen to be 32 kHz for the LRCK and 1 MHz for SCK while getting a distance sample.</p>
<h2>Memory requirements</h2>
<p >The DMA buffers require 2,144 of RAM at the default maximum measurement distance of 1 meter. The library can be configured for larger or smaller distances, which affect both RAM usage and the amount of time to measure a distance.</p>
<h1>Modes of operation</h1>
<p >The library essentially only works with one sensor. You could reinitialize it on different pins for multiple sensors, but you can't measure more than one sensor at the same time because the I2S peripheral has a single bit digital capture.</p>
<h2>Periodic with callback</h2>
<p >The recommended mode of operation is to assign a callback function, and set the sensor to periodically sample. The minimum period is around 10 milliseconds with a maximum distance of 1 meter. Ideally you should set to to be 300 milliseconds or larger to account for timeout situations.</p>
<p >The callback is called with a DistanceResult object that contains the distance which you can retrieve in meters, centimeters, or inches. It will also include a status code, such as SUCCESS, RANGE_ERROR (too close or too far), BUSY, or other errors.</p>
<p >See the example examples/1-simple for how to use this mode.</p>
<h2>Single sample with callback</h2>
<p >If you only need a single sample, you can do that as well.</p>
<h2>Single sample synchronous</h2>
<p >This is not recommended, because it will block the current thread for up to the safety timer period, which is 300 milliseconds. Using the callback or polling is preferable.</p>
<h2>Alarm mode</h2>
<p >Alarm mode calls the callback when the alarm condition is entered or exited. The alarm condition is a distance, along with an less than or greater than test, and a hysteresis value. It can be used to alert when you are too close or too far away from the thing being measured.</p>
<p >If you want to measure for change in distance, use the periodic measurement mode directly instead.</p>
<p >See the example examples/2-alarm for how to use this mode.</p>
<h1>Usage</h1>
<ul>
<li>Include the library, such as by using <code>Particle: Install Library</code> in Particle Workbench, or by adding the <b>JSN-SR04_Gen3_RK</b> library in the Web IDE.</li>
<li>Add the necessary header file:</li>
</ul>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;JSN-SR04_Gen3_RK.h&quot;</span></div>
</div><!-- fragment --><ul>
<li>Declare one of these as a global variable to manage the JSN-SR04 sensor:</li>
</ul>
<div class="fragment"><div class="line"><a class="code hl_class" href="class_j_s_n___s_r04___gen3.html">JSN_SR04_Gen3</a> distanceSensor;</div>
<div class="ttc" id="aclass_j_s_n___s_r04___gen3_html"><div class="ttname"><a href="class_j_s_n___s_r04___gen3.html">JSN_SR04_Gen3</a></div><div class="ttdoc">Class for a JSN-SR04 ultrasonic distance sensor.</div><div class="ttdef"><b>Definition:</b> JSN-SR04_Gen3_RK.h:16</div></div>
</div><!-- fragment --><ul>
<li>In setup(), initialize the sensor pins and settings</li>
</ul>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> setup() {</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Initialize the sensor configuration from setup()</span></div>
<div class="line">    distanceSensor</div>
<div class="line">        .<a class="code hl_function" href="class_j_s_n___s_r04___gen3.html#a82e4e472545ce2a8e49aed20b48c0374">withTrigPin</a>(D3)</div>
<div class="line">        .<a class="code hl_function" href="class_j_s_n___s_r04___gen3.html#a10ea1e22072e2263199e2d7c86f06112">withEchoPin</a>(D4)</div>
<div class="line">        .<a class="code hl_function" href="class_j_s_n___s_r04___gen3.html#aad629b79ad6d444577fa80395bde387d">withUnusedPins</a>(A0, A1)</div>
<div class="line">        .<a class="code hl_function" href="class_j_s_n___s_r04___gen3.html#a0bc8260fa479102c18138e88e381441e">setup</a>();</div>
<div class="line">}</div>
<div class="ttc" id="aclass_j_s_n___s_r04___gen3_html_a0bc8260fa479102c18138e88e381441e"><div class="ttname"><a href="class_j_s_n___s_r04___gen3.html#a0bc8260fa479102c18138e88e381441e">JSN_SR04_Gen3::setup</a></div><div class="ttdeci">bool setup()</div><div class="ttdoc">You typically call this from setup() after setting all of the configuration parameters using the with...</div><div class="ttdef"><b>Definition:</b> JSN-SR04_Gen3_RK.cpp:49</div></div>
<div class="ttc" id="aclass_j_s_n___s_r04___gen3_html_a10ea1e22072e2263199e2d7c86f06112"><div class="ttname"><a href="class_j_s_n___s_r04___gen3.html#a10ea1e22072e2263199e2d7c86f06112">JSN_SR04_Gen3::withEchoPin</a></div><div class="ttdeci">JSN_SR04_Gen3 &amp; withEchoPin(pin_t echoPin)</div><div class="ttdoc">Specifies the ECHO pin (INPUT)</div><div class="ttdef"><b>Definition:</b> JSN-SR04_Gen3_RK.h:382</div></div>
<div class="ttc" id="aclass_j_s_n___s_r04___gen3_html_a82e4e472545ce2a8e49aed20b48c0374"><div class="ttname"><a href="class_j_s_n___s_r04___gen3.html#a82e4e472545ce2a8e49aed20b48c0374">JSN_SR04_Gen3::withTrigPin</a></div><div class="ttdeci">JSN_SR04_Gen3 &amp; withTrigPin(pin_t trigPin)</div><div class="ttdoc">Specifies the TRIG pin (OUTPUT)</div><div class="ttdef"><b>Definition:</b> JSN-SR04_Gen3_RK.h:367</div></div>
<div class="ttc" id="aclass_j_s_n___s_r04___gen3_html_aad629b79ad6d444577fa80395bde387d"><div class="ttname"><a href="class_j_s_n___s_r04___gen3.html#aad629b79ad6d444577fa80395bde387d">JSN_SR04_Gen3::withUnusedPins</a></div><div class="ttdeci">JSN_SR04_Gen3 &amp; withUnusedPins(pin_t unusedPin1, pin_t unusedPin2)</div><div class="ttdoc">You must specify two GPIO that are not otherwise used that will be used as outputs by this library.</div><div class="ttdef"><b>Definition:</b> JSN-SR04_Gen3_RK.h:398</div></div>
</div><!-- fragment --><ul>
<li>Be sure to call the loop() method from loop()!</li>
</ul>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> loop() {</div>
<div class="line">    <span class="comment">// You must call this frequently from loop(), preferable on every execution</span></div>
<div class="line">    distanceSensor.<a class="code hl_function" href="class_j_s_n___s_r04___gen3.html#ac579ae54652b8920462eee93de5e99b5">loop</a>();</div>
<div class="line">}</div>
<div class="ttc" id="aclass_j_s_n___s_r04___gen3_html_ac579ae54652b8920462eee93de5e99b5"><div class="ttname"><a href="class_j_s_n___s_r04___gen3.html#ac579ae54652b8920462eee93de5e99b5">JSN_SR04_Gen3::loop</a></div><div class="ttdeci">void loop()</div><div class="ttdoc">You must call this from loop()</div><div class="ttdef"><b>Definition:</b> JSN-SR04_Gen3_RK.cpp:116</div></div>
</div><!-- fragment --><ul>
<li>If you are using a callback (recommended), the function might look something like this:</li>
</ul>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> distanceCallback(<a class="code hl_class" href="class_j_s_n___s_r04___gen3_1_1_distance_result.html">JSN_SR04_Gen3::DistanceResult</a> result) {</div>
<div class="line">    <span class="keywordflow">switch</span>(result.<a class="code hl_variable" href="class_j_s_n___s_r04___gen3_1_1_distance_result.html#a07ca9e0c3a7a1f0736304891c1dabbb2">status</a>) {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_enumvalue" href="class_j_s_n___s_r04___gen3_1_1_distance_result.html#a8a6f810c551b9034b1fb69d087b919a6ad0749aaba8b833466dfcbb0428e4f89c">JSN_SR04_Gen3::DistanceResult::Status::SUCCESS</a>:</div>
<div class="line">            Log.info(<span class="stringliteral">&quot;cm=%lf inch=%lf&quot;</span>, result.<a class="code hl_function" href="class_j_s_n___s_r04___gen3_1_1_distance.html#ac6c9d22e55bed7584224d7370b89baec">cm</a>(), result.<a class="code hl_function" href="class_j_s_n___s_r04___gen3_1_1_distance.html#a92ae8d4eb7b6eb4cd735c070bfcc223f">inch</a>());</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">case</span> <a class="code hl_enumvalue" href="class_j_s_n___s_r04___gen3_1_1_distance_result.html#a8a6f810c551b9034b1fb69d087b919a6a20b3033861fb9032b6a6f96c5ad3ef66">JSN_SR04_Gen3::DistanceResult::Status::RANGE_ERROR</a>:</div>
<div class="line">            Log.info(<span class="stringliteral">&quot;distance range error&quot;</span>);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            Log.info(<span class="stringliteral">&quot;distance error %d&quot;</span>, result.<a class="code hl_variable" href="class_j_s_n___s_r04___gen3_1_1_distance_result.html#a07ca9e0c3a7a1f0736304891c1dabbb2">status</a>);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="aclass_j_s_n___s_r04___gen3_1_1_distance_html_a92ae8d4eb7b6eb4cd735c070bfcc223f"><div class="ttname"><a href="class_j_s_n___s_r04___gen3_1_1_distance.html#a92ae8d4eb7b6eb4cd735c070bfcc223f">JSN_SR04_Gen3::Distance::inch</a></div><div class="ttdeci">void inch(double inch)</div><div class="ttdoc">Set the distance in inches.</div><div class="ttdef"><b>Definition:</b> JSN-SR04_Gen3_RK.h:114</div></div>
<div class="ttc" id="aclass_j_s_n___s_r04___gen3_1_1_distance_html_ac6c9d22e55bed7584224d7370b89baec"><div class="ttname"><a href="class_j_s_n___s_r04___gen3_1_1_distance.html#ac6c9d22e55bed7584224d7370b89baec">JSN_SR04_Gen3::Distance::cm</a></div><div class="ttdeci">void cm(double cm)</div><div class="ttdoc">Set the distance in centimeters.</div><div class="ttdef"><b>Definition:</b> JSN-SR04_Gen3_RK.h:78</div></div>
<div class="ttc" id="aclass_j_s_n___s_r04___gen3_1_1_distance_result_html"><div class="ttname"><a href="class_j_s_n___s_r04___gen3_1_1_distance_result.html">JSN_SR04_Gen3::DistanceResult</a></div><div class="ttdoc">Structure passed to the callback when the distance has been retrieved.</div><div class="ttdef"><b>Definition:</b> JSN-SR04_Gen3_RK.h:175</div></div>
<div class="ttc" id="aclass_j_s_n___s_r04___gen3_1_1_distance_result_html_a07ca9e0c3a7a1f0736304891c1dabbb2"><div class="ttname"><a href="class_j_s_n___s_r04___gen3_1_1_distance_result.html#a07ca9e0c3a7a1f0736304891c1dabbb2">JSN_SR04_Gen3::DistanceResult::status</a></div><div class="ttdeci">Status status</div><div class="ttdoc">Current status value.</div><div class="ttdef"><b>Definition:</b> JSN-SR04_Gen3_RK.h:208</div></div>
<div class="ttc" id="aclass_j_s_n___s_r04___gen3_1_1_distance_result_html_a8a6f810c551b9034b1fb69d087b919a6a20b3033861fb9032b6a6f96c5ad3ef66"><div class="ttname"><a href="class_j_s_n___s_r04___gen3_1_1_distance_result.html#a8a6f810c551b9034b1fb69d087b919a6a20b3033861fb9032b6a6f96c5ad3ef66">JSN_SR04_Gen3::DistanceResult::Status::RANGE_ERROR</a></div><div class="ttdeci">@ RANGE_ERROR</div><div class="ttdoc">Too close or too far away to detect.</div></div>
<div class="ttc" id="aclass_j_s_n___s_r04___gen3_1_1_distance_result_html_a8a6f810c551b9034b1fb69d087b919a6ad0749aaba8b833466dfcbb0428e4f89c"><div class="ttname"><a href="class_j_s_n___s_r04___gen3_1_1_distance_result.html#a8a6f810c551b9034b1fb69d087b919a6ad0749aaba8b833466dfcbb0428e4f89c">JSN_SR04_Gen3::DistanceResult::Status::SUCCESS</a></div><div class="ttdeci">@ SUCCESS</div><div class="ttdoc">Success, got a valid looking measurement.</div></div>
</div><!-- fragment --><h1><a class="el" href="class_j_s_n___s_r04___gen3.html" title="Class for a JSN-SR04 ultrasonic distance sensor.">JSN_SR04_Gen3</a> API</h1>
<p >Class for a JSN-SR04 ultrasonic distance sensor.</p>
<p >Note: You can effectively only have one instance of this class per device, because there is only one I2S peripheral, which is what is used to implement the device driver.</p>
<hr  />
<h2><a class="el" href="class_j_s_n___s_r04___gen3.html" title="Class for a JSN-SR04 ultrasonic distance sensor.">JSN_SR04_Gen3</a> &amp; <a class="el" href="class_j_s_n___s_r04___gen3.html#a82e4e472545ce2a8e49aed20b48c0374" title="Specifies the TRIG pin (OUTPUT)">JSN_SR04_Gen3::withTrigPin(pin_t trigPin)</a></h2>
<p >Specifies the TRIG pin (OUTPUT)</p>
<div class="fragment"><div class="line">JSN_SR04_Gen3 &amp; withTrigPin(pin_t trigPin)</div>
</div><!-- fragment --><h3>Parameters</h3>
<ul>
<li><code>trigPin</code> A pin, such as D2 or A0, or another port that is not being used, such as TX, RX, DAC, etc.</li>
</ul>
<h3>Returns</h3>
<p ><a class="el" href="class_j_s_n___s_r04___gen3.html" title="Class for a JSN-SR04 ultrasonic distance sensor.">JSN_SR04_Gen3</a>&amp; This object, for chaining options, fluent-style</p>
<hr  />
<h2><a class="el" href="class_j_s_n___s_r04___gen3.html" title="Class for a JSN-SR04 ultrasonic distance sensor.">JSN_SR04_Gen3</a> &amp; <a class="el" href="class_j_s_n___s_r04___gen3.html#a10ea1e22072e2263199e2d7c86f06112" title="Specifies the ECHO pin (INPUT)">JSN_SR04_Gen3::withEchoPin(pin_t echoPin)</a></h2>
<p >Specifies the ECHO pin (INPUT)</p>
<div class="fragment"><div class="line">JSN_SR04_Gen3 &amp; withEchoPin(pin_t echoPin)</div>
</div><!-- fragment --><h3>Parameters</h3>
<ul>
<li><code>echoPin</code> A pin, such as D2 or A0, or another port that is not being used, such as TX, RX, DAC, etc.</li>
</ul>
<h3>Returns</h3>
<p ><a class="el" href="class_j_s_n___s_r04___gen3.html" title="Class for a JSN-SR04 ultrasonic distance sensor.">JSN_SR04_Gen3</a>&amp; This object, for chaining options, fluent-style</p>
<p >The ECHO pin is typically a 5V logic level. You MUST add a level shifter before connecting it to a Particle Gen 3 device GPIO because GPIO are not 5V tolerant on the nRF52!</p>
<p >The ECHO pin on a JSN-SR04 is driven by a push-pull driver so you can only connect a single sensor to a single GPIO.</p>
<hr  />
<h2><a class="el" href="class_j_s_n___s_r04___gen3.html" title="Class for a JSN-SR04 ultrasonic distance sensor.">JSN_SR04_Gen3</a> &amp; <a class="el" href="class_j_s_n___s_r04___gen3.html#aad629b79ad6d444577fa80395bde387d" title="You must specify two GPIO that are not otherwise used that will be used as outputs by this library.">JSN_SR04_Gen3::withUnusedPins(pin_t unusedPin1, pin_t unusedPin2)</a></h2>
<p >You must specify two GPIO that are not otherwise used that will be used as outputs by this library.</p>
<div class="fragment"><div class="line">JSN_SR04_Gen3 &amp; withUnusedPins(pin_t unusedPin1, pin_t unusedPin2)</div>
</div><!-- fragment --><h3>Parameters</h3>
<ul>
<li><code>unusedPin1</code> A pin, such as D2 or A0, or another port that is not being used, such as TX, RX, DAC, etc.</li>
<li><code>unusedPin2</code> A pin, such as D2 or A0, or another port that is not being used, such as TX, RX, DAC, etc. Must be different than unusedPin1.</li>
</ul>
<h3>Returns</h3>
<p ><a class="el" href="class_j_s_n___s_r04___gen3.html" title="Class for a JSN-SR04 ultrasonic distance sensor.">JSN_SR04_Gen3</a>&amp; This object, for chaining options, fluent-style</p>
<p >You need to dedicate two other pins, unusedPin1 and unusedPin2. These must not be the same pin, and can't be used for anything else for all practical purposes. This is due to how the I2S peripheral works. You have to assign the I2S LRCK and SCK to pins or the nRF52 I2S peripheral won't initialize. You won't need these outputs for anything, but they do need to be assigned GPIOs. The signals happen to be 32 kHz for the LRCK and 1 MHz for SCK while getting a distance sample.</p>
<hr  />
<h2><a class="el" href="class_j_s_n___s_r04___gen3.html" title="Class for a JSN-SR04 ultrasonic distance sensor.">JSN_SR04_Gen3</a> &amp; <a class="el" href="class_j_s_n___s_r04___gen3.html#a500c7b5c278638f9a8024734d264b4c2" title="The maximum length that can be measured in meters. Default: 1 meter.">JSN_SR04_Gen3::withMaxLengthMeters(float maxLengthM)</a></h2>
<p >The maximum length that can be measured in meters. Default: 1 meter.</p>
<div class="fragment"><div class="line">JSN_SR04_Gen3 &amp; withMaxLengthMeters(float maxLengthM)</div>
</div><!-- fragment --><h3>Parameters</h3>
<ul>
<li><code>maxLengthM</code> Distance in meters</li>
</ul>
<h3>Returns</h3>
<p ><a class="el" href="class_j_s_n___s_r04___gen3.html" title="Class for a JSN-SR04 ultrasonic distance sensor.">JSN_SR04_Gen3</a>&amp; This object, for chaining options, fluent-style</p>
<p >This affects the amount of memory that is used, and also the amount of time a sampling takes. See the README for more information.</p>
<p >At the default is 1 meter, the memory is 2,080 bytes and the time is 9 milliseconds.</p>
<hr  />
<h2><a class="el" href="class_j_s_n___s_r04___gen3.html" title="Class for a JSN-SR04 ultrasonic distance sensor.">JSN_SR04_Gen3</a> &amp; <a class="el" href="class_j_s_n___s_r04___gen3.html#a43087ed1bd6805f4df04b2c017f21089" title="Specify a callback function to be called on samples, errors, and alarm conditions.">JSN_SR04_Gen3::withCallback(std::function&lt; void(DistanceResult)&gt; callback)</a></h2>
<p >Specify a callback function to be called on samples, errors, and alarm conditions.</p>
<div class="fragment"><div class="line">JSN_SR04_Gen3 &amp; withCallback(std::function&lt; void(DistanceResult)&gt; callback)</div>
</div><!-- fragment --><h3>Parameters</h3>
<ul>
<li><code>callback</code> The callback function</li>
</ul>
<h3>Returns</h3>
<p ><a class="el" href="class_j_s_n___s_r04___gen3.html" title="Class for a JSN-SR04 ultrasonic distance sensor.">JSN_SR04_Gen3</a>&amp; This object, for chaining options, fluent-style</p>
<p >The callback function has the prototype;</p>
<p >void callback(DistanceResult distanceResult)</p>
<p >It can be a C++11 lambda, if desired, to call a class member function.</p>
<hr  />
<h2><a class="el" href="class_j_s_n___s_r04___gen3.html" title="Class for a JSN-SR04 ultrasonic distance sensor.">JSN_SR04_Gen3</a> &amp; <a class="el" href="class_j_s_n___s_r04___gen3.html#a3b0cf0f66f35be4fcd5dd4c0d213293c" title="Enabling periodic sampling mode.">JSN_SR04_Gen3::withSamplePeriodic(std::chrono::milliseconds period)</a></h2>
<p >Enabling periodic sampling mode.</p>
<div class="fragment"><div class="line">JSN_SR04_Gen3 &amp; withSamplePeriodic(std::chrono::milliseconds period)</div>
</div><!-- fragment --><h3>Parameters</h3>
<ul>
<li><code>period</code> The sampling period as a chrono literal, such as 500ms, 10s, etc.</li>
</ul>
<h3>Returns</h3>
<p ><a class="el" href="class_j_s_n___s_r04___gen3.html" title="Class for a JSN-SR04 ultrasonic distance sensor.">JSN_SR04_Gen3</a>&amp; This object, for chaining options, fluent-style</p>
<p >It's recommended to specify a sampling period greater than safetyTimeoutMs milliseconds (currently 300). However, in practice you can specify a much faster sampling period, as low as getSampleTimeMs() milliseconds. The latter varies depending on the max length meters. At the default value of 1 meter, you can use a periodic sample rate at low as 10 milliseconds, however you might not get every sample. The sensor may not always reset in time an the BUSY error will be called on the callback.</p>
<hr  />
<h2><a class="el" href="class_j_s_n___s_r04___gen3.html" title="Class for a JSN-SR04 ultrasonic distance sensor.">JSN_SR04_Gen3</a> &amp; <a class="el" href="class_j_s_n___s_r04___gen3.html#aa5792c6a8fc48c15dd3b8066ce3241ca" title="Enabling periodic sampling mode.">JSN_SR04_Gen3::withSamplePeriodicMs(unsigned long periodMs)</a></h2>
<p >Enabling periodic sampling mode.</p>
<div class="fragment"><div class="line">JSN_SR04_Gen3 &amp; withSamplePeriodicMs(unsigned long periodMs)</div>
</div><!-- fragment --><h3>Parameters</h3>
<ul>
<li><code>periodMs</code> The sampling period in milliseconds</li>
</ul>
<h3>Returns</h3>
<p ><a class="el" href="class_j_s_n___s_r04___gen3.html" title="Class for a JSN-SR04 ultrasonic distance sensor.">JSN_SR04_Gen3</a>&amp; This object, for chaining options, fluent-style</p>
<p >It's recommended to specify a sampling period greater than safetyTimeoutMs milliseconds (currently 300). However, in practice you can specify a much faster sampling period, as low as getSampleTimeMs() milliseconds. The latter varies depending on the max length meters. At the default value of 1 meter, you can use a periodic sample rate at low as 10 milliseconds, however you might not get every sample. The sensor may not always reset in time an the BUSY error will be called on the callback.</p>
<hr  />
<h2><a class="el" href="class_j_s_n___s_r04___gen3.html" title="Class for a JSN-SR04 ultrasonic distance sensor.">JSN_SR04_Gen3</a> &amp; <a class="el" href="class_j_s_n___s_r04___gen3.html#afdb9e0752e2ec859b11982d76910b8d0" title="Enable distance alarm mode.">JSN_SR04_Gen3::withDistanceAlarm(DistanceAlarm distanceAlarm)</a></h2>
<p >Enable distance alarm mode.</p>
<div class="fragment"><div class="line">JSN_SR04_Gen3 &amp; withDistanceAlarm(DistanceAlarm distanceAlarm)</div>
</div><!-- fragment --><h3>Parameters</h3>
<ul>
<li><code>distanceAlarm</code> The distance alarm configuration</li>
</ul>
<h3>Returns</h3>
<p ><a class="el" href="class_j_s_n___s_r04___gen3.html" title="Class for a JSN-SR04 ultrasonic distance sensor.">JSN_SR04_Gen3</a>&amp; This object, for chaining options, fluent-style</p>
<hr  />
<h2>bool <a class="el" href="class_j_s_n___s_r04___gen3.html#a0bc8260fa479102c18138e88e381441e" title="You typically call this from setup() after setting all of the configuration parameters using the with...">JSN_SR04_Gen3::setup()</a></h2>
<p >You typically call this from setup() after setting all of the configuration parameters using the withXXX() methods.</p>
<div class="fragment"><div class="line">bool setup()</div>
</div><!-- fragment --><p >You must call setup() before any samples can be taken.</p>
<hr  />
<h2>void <a class="el" href="class_j_s_n___s_r04___gen3.html#ac579ae54652b8920462eee93de5e99b5" title="You must call this from loop()">JSN_SR04_Gen3::loop()</a></h2>
<p >You must call this from loop()</p>
<div class="fragment"><div class="line">void loop()</div>
</div><!-- fragment --><hr  />
<h2>bool <a class="el" href="class_j_s_n___s_r04___gen3.html#ad94feb674d2c6a001c56c15dca1a5815" title="Get a sample from the sensor.">JSN_SR04_Gen3::sampleOnce()</a></h2>
<p >Get a sample from the sensor.</p>
<div class="fragment"><div class="line">bool sampleOnce()</div>
</div><!-- fragment --><h3>Returns</h3>
<p >true</p>
<h3>Returns</h3>
<p >false</p>
<p >You still must configure the pins and call the setup() method. You must also call the loop() method from loop().</p>
<hr  />
<h2>DistanceResult <a class="el" href="class_j_s_n___s_r04___gen3.html#a1df4e5a8bd628c0951e664399aa1120f" title="Synchronous version of sampleOnce - not recommended.">JSN_SR04_Gen3::sampleOnceSync()</a></h2>
<p >Synchronous version of sampleOnce - not recommended.</p>
<div class="fragment"><div class="line">DistanceResult sampleOnceSync()</div>
</div><!-- fragment --><h3>Returns</h3>
<p >DistanceResult</p>
<p >Using the asynchronous callback is preferable, but this call is provided to make it somewhat easier to convert code from other libraries.</p>
<hr  />
<h2>DistanceResult <a class="el" href="class_j_s_n___s_r04___gen3.html#adf8e4315593e8e44eda5607540d03741" title="Gets the last result code.">JSN_SR04_Gen3::getLastResult() const</a></h2>
<p >Gets the last result code.</p>
<div class="fragment"><div class="line">DistanceResult getLastResult() const</div>
</div><!-- fragment --><h3>Returns</h3>
<p >DistanceResult</p>
<p >Normally you should use the callback, but if you want to poll instead of using a callback you can use this function for periodic, sample once, and alarm modes.</p>
<hr  />
<h2>unsigned long <a class="el" href="class_j_s_n___s_r04___gen3.html#ac6651c2b1aadf19993b1f471a301f3b6" title="Returns the number of milliseconds it takes to process a sample.">JSN_SR04_Gen3::getSampleTimeMs() const</a></h2>
<p >Returns the number of milliseconds it takes to process a sample.</p>
<div class="fragment"><div class="line">unsigned long getSampleTimeMs() const</div>
</div><!-- fragment --><h3>Returns</h3>
<p >unsigned long number of milliseconds</p>
<p >In practice it might take a few milliseconds longer because of the delays in dispatching loop(). The value is calculated from the maxLengthM and leadingOverhead values.</p>
<p >With the default value of 1 meter maximum and 152 leadingOverhead, this returns 9 milliseconds.</p>
<p >In theory you could sample at around every 9 milliseconds, maybe 10, but it's probably best to limit it to 100 milliseconds, or even 500 milliseconds, to be safe. If you sample frequently, be sure to handle the case where BUSY status is returned. This means that that sensor has not yet reset the ECHO output low and a sample cannot be taken yet.</p>
<p >Note that the callback will not be called for at least this long, regardless of distance! The reason is that the sample buffer is not processed until the DMA engine stops writing to the entire buffer, and then it waits until in loop context again.</p>
<h1><a class="el" href="class_j_s_n___s_r04___gen3_1_1_distance_result.html" title="Structure passed to the callback when the distance has been retrieved.">JSN_SR04_Gen3::DistanceResult</a> API</h1>
<div class="fragment"><div class="line">class JSN_SR04_Gen3::DistanceResult</div>
<div class="line">  : public JSN_SR04_Gen3::Distance</div>
</div><!-- fragment --><p >Structure passed to the callback when the distance has been retrieved.</p>
<p >This includes a Status enum for the result status, and optionally a distance as this class is derived from class Distance. Thus you can use the inherited methods such as cm(), mm(), and inch() to get the distance in centimeters, millimeters, or inches, for example.</p>
<h2>Status status</h2>
<p >Current status value.</p>
<div class="fragment"><div class="line">Status status</div>
</div><!-- fragment --><hr  />
<h2>Status <a class="el" href="class_j_s_n___s_r04___gen3_1_1_distance_result.html#aa25dba0ec72dcbbb3b006789ecb51e24" title="Get the Status value for this result.">JSN_SR04_Gen3::DistanceResult::getStatus() const</a></h2>
<p >Get the Status value for this result.</p>
<div class="fragment"><div class="line">Status getStatus() const</div>
</div><!-- fragment --><h3>Returns</h3>
<p >Status</p>
<hr  />
<h2>bool <a class="el" href="class_j_s_n___s_r04___gen3_1_1_distance_result.html#a70e7d8217cd9e73ebc10aa76c96fcc78" title="Helper function to return true if the Status is SUCCESS.">JSN_SR04_Gen3::DistanceResult::success() const</a></h2>
<p >Helper function to return true if the Status is SUCCESS.</p>
<div class="fragment"><div class="line">bool success() const</div>
</div><!-- fragment --><h3>Returns</h3>
<p >true</p>
<h3>Returns</h3>
<p >false</p>
<hr  />
<h2>enum Status</h2>
<p >Status of the call.</p>
<div class="fragment"><div class="line">enum Status</div>
</div><!-- fragment --><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Values   </th><th class="markdownTableHeadNone">Descriptions    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">SUCCESS   </td><td class="markdownTableBodyNone">Success, got a valid looking measurement.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">ERROR   </td><td class="markdownTableBodyNone">An internal error (problem with the I2S peripheral, etc.)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">RANGE_ERROR   </td><td class="markdownTableBodyNone">Too close or too far away to detect.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">BUSY   </td><td class="markdownTableBodyNone">Called before the previous call completed.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">IN_PROGRESS   </td><td class="markdownTableBodyNone">Call is in progress (getting sample from sensor)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">ENTER_ALARM   </td><td class="markdownTableBodyNone">When using distance alarm, entering alarm state.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">EXIT_ALARM   </td><td class="markdownTableBodyNone">When using distance alarm, exiting alarm state.   </td></tr>
</table>
<h1>class <a class="el" href="class_j_s_n___s_r04___gen3_1_1_distance.html" title="Utility class for holding a distance.">JSN_SR04_Gen3::Distance</a></h1>
<p >Utility class for holding a distance.</p>
<p >The storage value is in meters, but there are accessors for cm, mm, and inches. This is used for both getting distances (the sensor value) as well as setting distances (for distance alarm mode).</p>
<p >The <a class="el" href="class_j_s_n___s_r04___gen3_1_1_distance_result.html" title="Structure passed to the callback when the distance has been retrieved.">JSN_SR04_Gen3::DistanceResult</a> class is derived from this class, so the methods here can be used with a DistanceResult that is passed to the callback.</p>
<h3>double distanceM</h3>
<p >The value of the distance in meters.</p>
<div class="fragment"><div class="line">double distanceM</div>
</div><!-- fragment --><hr  />
<h3><a class="el" href="class_j_s_n___s_r04___gen3_1_1_distance.html#aa76594a36651191459e70b44c7a41af1" title="Construct a new Distance object with a distance of 0.">JSN_SR04_Gen3::Distance::Distance()</a></h3>
<p >Construct a new Distance object with a distance of 0.</p>
<div class="fragment"><div class="line">Distance()</div>
</div><!-- fragment --><hr  />
<h3><a class="el" href="class_j_s_n___s_r04___gen3_1_1_distance.html#a0c7928c544d11e4017d9edd42abf2663" title="Construct a new Distance object with a distance in meters.">JSN_SR04_Gen3::Distance::Distance(double valueM)</a></h3>
<p >Construct a new Distance object with a distance in meters.</p>
<div class="fragment"><div class="line">Distance(double valueM)</div>
</div><!-- fragment --><h4>Parameters</h4>
<ul>
<li><code>valueM</code> distance in meters (double floating point)</li>
</ul>
<hr  />
<h3><a class="el" href="class_j_s_n___s_r04___gen3_1_1_distance.html#a4a6b397387d2d3772e02af20245415f0" title="Construct a new Distance object from another Distance object.">JSN_SR04_Gen3::Distance::Distance(const Distance &amp; value)</a></h3>
<p >Construct a new Distance object from another Distance object.</p>
<div class="fragment"><div class="line">Distance(const Distance &amp; value)</div>
</div><!-- fragment --><h4>Parameters</h4>
<ul>
<li><code>value</code> The object to copy the distance from</li>
</ul>
<hr  />
<h3>Distance &amp; <a class="el" href="class_j_s_n___s_r04___gen3_1_1_distance.html#adf1641f073d2f1f0456e67e84b221d03" title="Copy the distance value from another Distance object.">JSN_SR04_Gen3::Distance::operator=(const Distance &amp; value)</a></h3>
<p >Copy the distance value from another Distance object.</p>
<div class="fragment"><div class="line">Distance &amp; operator=(const Distance &amp; value)</div>
</div><!-- fragment --><h4>Parameters</h4>
<ul>
<li><code>value</code> The object to copy the distance from</li>
</ul>
<h4>Returns</h4>
<p >Distance&amp; Return this object, so you can chain multiple assignments</p>
<hr  />
<h3>void <a class="el" href="class_j_s_n___s_r04___gen3_1_1_distance.html#ab49504978d370a0add9cedc094bdd819" title="Set the Distance in meters.">JSN_SR04_Gen3::Distance::setDistanceM(double distanceM)</a></h3>
<p >Set the Distance in meters.</p>
<div class="fragment"><div class="line">void setDistanceM(double distanceM)</div>
</div><!-- fragment --><h4>Parameters</h4>
<ul>
<li><code>distanceM</code> the distance in meters to set</li>
</ul>
<hr  />
<h3>double <a class="el" href="class_j_s_n___s_r04___gen3_1_1_distance.html#a0d4c949c6b2bc331f637ce9a1effa54d" title="Get the Distance in meters.">JSN_SR04_Gen3::Distance::getDistanceM() const</a></h3>
<p >Get the Distance in meters.</p>
<div class="fragment"><div class="line">double getDistanceM() const</div>
</div><!-- fragment --><h4>Returns</h4>
<p >double Distance in meters</p>
<hr  />
<h3>void <a class="el" href="class_j_s_n___s_r04___gen3_1_1_distance.html#ac6c9d22e55bed7584224d7370b89baec" title="Set the distance in centimeters.">JSN_SR04_Gen3::Distance::cm(double cm)</a></h3>
<p >Set the distance in centimeters.</p>
<div class="fragment"><div class="line">void cm(double cm)</div>
</div><!-- fragment --><h4>Parameters</h4>
<ul>
<li><code>cm</code> Distance in centimeters (double floating point)</li>
</ul>
<p >Internally, the distance is stored in meters, but this sets the value in centimeters. You can mix-and-match, for example you can get the distance in inches after setting it in centimeters.</p>
<hr  />
<h3>double <a class="el" href="class_j_s_n___s_r04___gen3_1_1_distance.html#abf06540de904191a76e7d4b5b46222f6" title="Get the value of the Distance in centimeters.">JSN_SR04_Gen3::Distance::cm() const</a></h3>
<p >Get the value of the Distance in centimeters.</p>
<div class="fragment"><div class="line">double cm() const</div>
</div><!-- fragment --><h4>Returns</h4>
<p >double Distance in centimeters</p>
<hr  />
<h3>void <a class="el" href="class_j_s_n___s_r04___gen3_1_1_distance.html#adeb477785a56fafaa13ad8c9b799f8d4" title="Set the distance in millimeter.">JSN_SR04_Gen3::Distance::mm(double mm)</a></h3>
<p >Set the distance in millimeter.</p>
<div class="fragment"><div class="line">void mm(double mm)</div>
</div><!-- fragment --><h4>Parameters</h4>
<ul>
<li><code>mm</code> Distance in millimeters (double floating point)</li>
</ul>
<p >Internally, the distance is stored in meters, but this sets the value in millimeters. You can mix-and-match, for example you can get the distance in inches after setting it in millimeters.</p>
<hr  />
<h3>double <a class="el" href="class_j_s_n___s_r04___gen3_1_1_distance.html#a01ba2161c0f290e29c813d9bbff29ee4" title="Get the value of the Distance in millimeters.">JSN_SR04_Gen3::Distance::mm() const</a></h3>
<p >Get the value of the Distance in millimeters.</p>
<div class="fragment"><div class="line">double mm() const</div>
</div><!-- fragment --><h4>Returns</h4>
<p >double Distance in millimeters</p>
<hr  />
<h3>void <a class="el" href="class_j_s_n___s_r04___gen3_1_1_distance.html#a92ae8d4eb7b6eb4cd735c070bfcc223f" title="Set the distance in inches.">JSN_SR04_Gen3::Distance::inch(double inch)</a></h3>
<p >Set the distance in inches.</p>
<div class="fragment"><div class="line">void inch(double inch)</div>
</div><!-- fragment --><h4>Parameters</h4>
<ul>
<li><code>inch</code> Distance in inches (double floating point)</li>
</ul>
<p >Internally, the distance is stored in meters, but this sets the value in inches. You can mix-and-match, for example you can get the distance in centimeters after setting it in inches.</p>
<hr  />
<h3>double <a class="el" href="class_j_s_n___s_r04___gen3_1_1_distance.html#a6f64284f02f2794d73736d8435ee6a0c" title="Get the value of the Distance in inches.">JSN_SR04_Gen3::Distance::inch() const</a></h3>
<p >Get the value of the Distance in inches.</p>
<div class="fragment"><div class="line">double inch() const</div>
</div><!-- fragment --><h4>Returns</h4>
<p >double Distance in inches</p>
<h2>Calculations</h2>
<p >The TRIG pin is normally low, you pulse it high for 10 µS to begin measurement.</p>
<p >The ECHO pin is normally low, it will go high during the measurement, and the length of the high pulse determines the distance:</p>
<p >Distance = (T × C) / 2</p>
<p >where:</p>
<ul>
<li>T is the time of the pulse in seconds <br  />
</li>
<li>C is the speed of sound (340 meters/sec)</li>
</ul>
<p >The detection range of the sensor I got is 2 cm (0.02 m) to 500 cm (5 m). This means the time of the pulse ranges from:</p>
<ul>
<li>Min: 0.02 m = 0.00011765 sec = 0.1176 ms = 117 µs</li>
<li>Max: 5 m = 0.0294 sec = 29 ms</li>
</ul>
<p >The accuracy of the sensor I got is claimed to be 0.3 cm, or 0.0003 meters.</p>
<ul>
<li>0.0003 meters = 0.00000186 sec = 0.00176 milliseconds = 1.76 microseconds</li>
<li>568,181 Hz</li>
</ul>
<p >We want to sample at roughly twice that frequency, if possible, or even higher.</p>
<p >The I2S peripheral has many possible configurations:</p>
<p ><img src="i2sconfig.png" alt="" class="inline"/></p>
<p >Note that the sample rate (LRCK), is the number of 16-bit stereo samples. Each bit of our input is one of those bits, so a sample rate of 32000 Hz is actually samples at 1,024,000 Hz, which is close to our target. Perfect!</p>
<p >In other words, with a 1 MHz sample rate, we can measure the width of a pulse with a resolution if 1 µs (1 microsecond), without touching interrupts and with no interrupt latency, because the I2S peripheral does not require bit-level interrupts.</p>
<p >The total buffer length is the length of the TRIG pulse (10 µS) + setup time + maximum detection pulse (up to 29 ms).</p>
<p >The TRIG pulse output should be 10 µs. This is a minimum of 10 bits of output 1. We use 16 bits because it's really convenient with 16-bit samples.</p>
<p >The setup time is not in the datasheet, but dumping the ECHO pin output from the sensor looks like this:</p>
<div class="fragment"><div class="line">0000005026 [app] INFO: 0090: 0000 0000 0000 0000</div>
<div class="line">0000005026 [app] INFO: 0094: 03ff ffff ffff ffff</div>
<div class="line">0000005027 [app] INFO: 0098: ffff ffff ffff ffff</div>
<div class="line">0000005027 [app] INFO: 009c: ffff ffff ffff ffff</div>
<div class="line">0000005028 [app] INFO: 00a0: ffff ffff ffff ffff</div>
<div class="line">0000005028 [app] INFO: 00a4: ffff ffff ffff ffff</div>
<div class="line">0000005029 [app] INFO: 00a8: ffff ffff ffff ffff</div>
<div class="line">0000005029 [app] INFO: 00ac: ffff ffff ffff ffff</div>
<div class="line">0000005030 [app] INFO: 00b0: ffff ffff ffff ffff</div>
<div class="line">0000005030 [app] INFO: 00b4: ffff ffff ffff ffff</div>
<div class="line">0000005031 [app] INFO: 00b8: ffff ffff fffe 0000</div>
<div class="line">0000005031 [app] INFO: 00bc: 0000 0000 0000 0000</div>
<div class="line">0000005032 [app] INFO: 00c0: 0000 0000 0000 0000</div>
</div><!-- fragment --><ul>
<li>The time from the falling TRIG pulse to ECHO going high is 0x93 16-bit samples (147), or 2.35 ms.</li>
<li>In other words, the leading overhead should be assumed to be around 150 16-bit samples.</li>
<li>When the signal goes high the sample has a value of 0x03ff. The leftmost (MSB) is the first, chronologically.</li>
<li>When the signal goes low the sample has a value of 0xfff3. The rightmost (LSB) is the last, chronologically.</li>
</ul>
<p >I set the leadingOverhead to 152 16-bit samples, or 2432 µs.</p>
<p >Even though this sensor is theoretically able to measure up to 5 meters, I've never had a sensor work at that distance reliably. To save RAM, I set the maximum distance to 1 meter. You could set it shorter or a longer if desired.</p>
<ul>
<li>D = 1 meters</li>
<li>C = 340 meters/sec</li>
<li>T = (2 × D) / C</li>
<li>T = 0.005882 sec = 5.882 ms = 5882 µs = 5,882 1-bit samples = 368 16-bit samples</li>
</ul>
<p >Adding in the 152 16-bit setup time results in 520 16-bit samples. This is 1,040 bytes, however we need both transmit and receive DMA buffers, so that's a total overhead of 2,080 bytes for transmit and receive buffers at 1 meter.</p>
<p >If you wanted a 2 meter range and had a sensor that worked acceptable at that range, it would require 3,552 bytes of buffer. The range is floating point, so you can specify fractions of a meter as well.</p>
<p >At a maximum distance of 5 meters, T = (2 × D) / C = 0.294 seconds = 294 milliseconds. This is where the 300 millisecond safety timer is derived from. If the sensor fails to respond in this amount of time, something has gone wrong.</p>
<p >The datasheet is silent as to what happens if you pulse TRIG high while ECHO is still high. The library returns a BUSY error if you attempt this since the behavior in unspecified.</p>
<p >The getSampleTimeMs() method returns the number of milliseconds it takes to process a sample. In practice it might take a few milliseconds longer because of the delays in dispatching loop().</p>
<p >The formula is:</p>
<ul>
<li>T = (2 × D) / C</li>
<li>leadingOverheadMs = leadingOverhead * 16 / 1000 = 152 * 16 / 1000 = 2.432 ms</li>
<li>Cms = 0.340 meters/millisecond</li>
<li>Tms = (2 × D) / Cms + leadingOverheadMs</li>
</ul>
<p >For the default of D = 1 meter:</p>
<ul>
<li>D = 1 meter</li>
<li>Tms = (2 × D) / Cms + leadingOverheadMs</li>
<li>Tms = 2 / 0.340 + 2.432</li>
<li>Tms = 8.31 ms (rounded up to 9)</li>
</ul>
<p >Thus in theory you could sample at around every 9 milliseconds, maybe 10, but it's probably best to limit it to 100 milliseconds, or even 500 milliseconds, to be safe. If you sample frequently, be sure to handle the case where BUSY status is returned. This means that that sensor has not yet reset the ECHO output low and a sample cannot be taken yet. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2
</small></address>
</body>
</html>
